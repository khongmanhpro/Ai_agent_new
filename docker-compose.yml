version: '3.8'

services:
  # Neo4J Database
  neo4j:
    image: neo4j:5.15
    container_name: insurance-neo4j
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD:-password}
      NEO4J_PLUGINS: '["graph-data-science"]'
      NEO4J_dbms_security_procedures_unrestricted: 'gds.*'
      NEO4J_dbms_security_procedures_allowlist: 'gds.*,apoc.*'
    ports:
      - "${NEO4J_PORT:-7474}:7474"  # HTTP
      - "${NEO4J_BOLT_PORT:-7687}:7687"  # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - ./neo4j-plugins:/plugins
    networks:
      - insurance-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "${NEO4J_PASSWORD:-password}", "MATCH () RETURN count(*) limit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Insurance Bot API
  insurance-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: insurance-bot-api
    environment:
      # Server Config
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8001}
      API_DEBUG: ${API_DEBUG:-false}

      # Database Config
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USERNAME: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}
      NEO4J_MAX_CONNECTION_POOL_SIZE: ${NEO4J_MAX_CONNECTION_POOL_SIZE:-50}

      # AI Config
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL}
      OPENAI_API_BASE: ${OPENAI_API_BASE}
      OPENAI_LLM_MODEL: ${OPENAI_LLM_MODEL:-gpt-4o-mini}
      OPENAI_LLM_MAX_TOKENS: ${OPENAI_LLM_MAX_TOKENS:-800}
      OPENAI_LLM_TEMPERATURE: ${OPENAI_LLM_TEMPERATURE:-0.7}

      # MiniRAG Config
      WORKING_DIR: /app/logs/insurance_rag
      KV_STORAGE: JsonKVStorage
      VECTOR_STORAGE: NanoVectorDBStorage
      GRAPH_STORAGE: Neo4JStorage
      EMBEDDING_TYPE: openai
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-text-embedding-3-small}

      # Performance Config
      TOP_K: ${TOP_K:-30}
      COSINE_THRESHOLD: ${COSINE_THRESHOLD:-0.3}
      CHUNK_TOKEN_SIZE: ${CHUNK_TOKEN_SIZE:-1000}
      CHUNK_OVERLAP_TOKEN_SIZE: ${CHUNK_OVERLAP_TOKEN_SIZE:-100}

      # Entity Config
      ENTITY_TYPES: ${ENTITY_TYPES:-customer,policy,insurance_type,vehicle,location,claim,date,amount}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

    ports:
      - "${API_PORT:-8001}:${API_PORT:-8001}"
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - insurance-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${API_PORT:-8001}/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis (optional - for caching)
  redis:
    image: redis:7-alpine
    container_name: insurance-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - insurance-network
    restart: unless-stopped
    command: redis-server --appendonly yes
    profiles:
      - with-redis

  # Monitoring (optional)
  prometheus:
    image: prom/prometheus:latest
    container_name: insurance-prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - insurance-network
    restart: unless-stopped
    profiles:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: insurance-grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - insurance-network
    restart: unless-stopped
    profiles:
      - monitoring

volumes:
  neo4j_data:
  neo4j_logs:
  redis_data:
  grafana_data:

networks:
  insurance-network:
    driver: bridge
